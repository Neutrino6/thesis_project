import os
import re
import shutil

#this directory
directory = os.path.dirname(__file__)

#wasm directory
wasm_directory = "/home/osboxes/Desktop/Malware_Bazaar/Wasm"

#move to this directory
destination_directory = os.path.join(directory, "With_dependency")

#create it if it doesn't exist
if not os.path.exists(destination_directory):
    os.makedirs(destination_directory)

#angular.js, bootstrap, jQuery
libraries = {
    "angular": [r'\bangular\b', r'import .*angular', r'require\(.*angular.*\)'],
    "bootstrap": [r'bootstrap', r'import .*bootstrap', r'require\(.*bootstrap.*\)'],
    "jquery": [r'\$', r'jQuery', r'import .*jquery', r'require\(.*jquery.*\)'],
    "electron": [r'\belectron\b', r'import .*electron', r'require\(.*electron.*\)'],
    "react": [r'\breact\b', r'import .*react', r'require\(.*react.*\)'],
}


files_with_dependencies = []

#scan all javascript files
for filename in os.listdir(directory):
    if filename.endswith(".js"):
        path = os.path.join(directory, filename)
        with open(path, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
            for lib, patterns in libraries.items():
                for pattern in patterns:
                    if re.search(pattern, content):
                        print(f"{filename} usa {lib}")
                        files_with_dependencies.append(filename)  #add to list if dependency
                        break

#search for corresponding wasm file 
for js_file in files_with_dependencies:
    wasm_file = js_file.replace(".js", ".wasm")
    wasm_file_path = os.path.join(wasm_directory, wasm_file)
    
    #move the file if it has dependency
    if os.path.exists(wasm_file_path):
        destination_path = os.path.join(destination_directory, wasm_file)
        shutil.move(wasm_file_path, destination_path)
        print(f"Spostato {wasm_file} in {destination_directory}")
    else:
        print(f"File .wasm per {js_file} non trovato nella cartella wasm.")

